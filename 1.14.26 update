<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://webgazer.cs.brown.edu/webgazer.js?" defer></script>
  <script src="script.js" defer></script>
  <title>iGaze â€” Demo Board</title>
  <link rel="stylesheet" href="css/styles.css">
  </style>
</head>

<body>
  <header>
    <div class="logo">
        <img src="images/igaze1.png" alt="iGaze Logo">
        <span>iGaze</span>
    </div>
    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </nav>
</header>
  <main class="wrap">
    <section class="hero">
      <h1>Empowering Communication Through Eye Tracking</h1>
      <p>Use the large tiles and on-screen keyboard to build a message. This demo uses mouse clicks todayâ€”later your team can map gaze + blink to the same selection events.</p>
      <div class="heroActions">
        <a class="btn primary" href="about.html">Learn more about iGaze â†’</a>
        <button class="btn primary" id="btnSpeakHero" type="button">ğŸ”Š Speak message</button>
      </div>
    </section>
    <section class="card">
      <div class="instructions">
        <div>
          <h2>Quick Instructions</h2>
          <ol class="steps">
  <li><b>Select tiles</b> (Yes/No/Stop/Please/Food/Drink/More/Less) to add words to the message bar.</li>
  <li>Use the <b>keyboard</b> to type extra words (names, places, custom needs).</li>
  <li>Tap a <b>suggestion</b> to auto-fill common phrases.</li>
  <li>Press <b>Speak</b> to hear the message.</li>

  <li><b>Eye Tracking Calibration (Silent Click Method):</b> When prompted, click <b>Allow</b> to enable camera access (eye tracking starts immediately).</li>
  <li>A dot will follow your cursor.</li>
  <li>To calibrate: <b>look anywhere</b> on the screen and <b>click where you are looking</b>.</li>
  <li>Repeat several clicks in different areas for better accuracy.</li>
  <li>If accuracy is off, <b>refresh the page</b> and calibrate again.</li>
</ol>

        </div>
        <div class="tipbox">
          Tip: In the final build, your eye-tracking layer can â€œclickâ€ a tile after a dwell time or blink.
          This UI is already structured so gaze selection can trigger the same events as a mouse click.
        <div id="calStatus" style="margin-top:10px;font-weight:900;">
  Calibration status: Waiting for camera permissionâ€¦
</div>

      </div>
    </section>
    <section class="layout">
      <!-- LEFT: Communication board -->
      <section aria-label="Communication board">
        <h2 style="margin:0 0 10px;">Demo Board</h2>

        <div class="sentenceRow">
          <div class="sentence" id="sentence" aria-live="polite">
            <span class="placeholder" id="placeholder">Select a tile or type with the keyboardâ€¦</span>
          </div>

<div class="typedBox" id="typedBox" aria-live="polite"></div>


          <div class="controls">
            <button class="ctrlBtn" id="btnSpeak" type="button">ğŸ”Š Speak</button>
            <button class="ctrlBtn" id="btnUndo" type="button">â†© Undo</button>
            <button class="ctrlBtn" id="btnClear" type="button">ğŸ§¹ Clear</button>
          </div>
        </div>

        <div class="grid" id="grid">
          <button class="tile yes" data-word="yes" type="button"><div class="icon">âœ…</div><div class="label">yes</div></button>
          <button class="tile no" data-word="no" type="button"><div class="icon">âŒ</div><div class="label">no</div></button>
          <button class="tile stop" data-word="stop" type="button"><div class="icon">ğŸ›‘</div><div class="label">stop</div></button>
          <button class="tile please" data-word="please" type="button"><div class="icon">ğŸ™</div><div class="label">please</div></button>

          <button class="tile food" data-word="food" type="button"><div class="icon">ğŸ</div><div class="label">food</div></button>
          <button class="tile drink" data-word="drink" type="button"><div class="icon">ğŸ’§</div><div class="label">drink</div></button>
          <button class="tile more" data-word="more" type="button"><div class="icon">â•</div><div class="label">more</div></button>
          <button class="tile less" data-word="less" type="button"><div class="icon">â–</div><div class="label">less</div></button>
        </div>

        <div class="suggestions" aria-label="Auto fill suggestions">
          <div class="suggestionsHeader">
            <div class="title">Auto Fill</div>
            <div class="small">Tap to insert a phrase</div>
          </div>
          <div class="suggestList" id="suggestList">
            <!-- suggestions inserted by JS -->
          </div>
        </div>
<div class="keyboard">
  <h3 style="margin:12px 0 6px;">On-Screen Keyboard</h3>
  <div id="kbd"></div>
</div>

      </section>

    </section>
  </main>

  <script>
const API_BASE = "https://vk8wz4h7q9.execute-api.us-east-2.amazonaws.com";

const WRITE_PATH = "/write-text"; // change if your route is /tts

async function writeTextToS3(text){
  if(!text) return;

  const url = API_BASE.replace(/\/$/, "") + WRITE_PATH;

  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text })
  });

  if (!res.ok){
    const msg = await res.text().catch(()=> "");
    throw new Error(`API ${res.status}: ${msg}`);
  }

  return res.json().catch(()=> ({}));
}

    // ===== State =====
    const phrase = [];              // array of words (chips)
    let typed = "";                 // typed buffer

    const sentenceEl = document.getElementById("sentence");
    const placeholderEl = document.getElementById("placeholder");
    const typedBoxEl = document.getElementById("typedBox");
    const suggestListEl = document.getElementById("suggestList");

    const btnSpeak = document.getElementById("btnSpeak");
    const btnUndo  = document.getElementById("btnUndo");
    const btnClear = document.getElementById("btnClear");
    const btnSpeakHero = document.getElementById("btnSpeakHero");

    // ===== Auto-fill suggestions (simple + relevant to your 8 tiles) =====
    // You can expand this later or generate dynamically.
    const suggestions = [
      "please help",
      "more please",
      "less please",
      "stop please",
      "food please",
      "drink please",
      "yes please",
      "no thank you"
    ];

    function renderSuggestions(){
      suggestListEl.innerHTML = "";
      for (const s of suggestions){
        const b = document.createElement("button");
        b.className = "suggest";
        b.type = "button";
        b.innerHTML = "âœ¨ " + s;
        b.addEventListener("click", () => insertPhrase(s));
        suggestListEl.appendChild(b);
      }
    }

    // ===== Rendering =====
    function renderSentence(){
      sentenceEl.innerHTML = "";
      if (phrase.length === 0){
        const p = document.createElement("span");
        p.className = "placeholder";
        p.textContent = "Select a tile or type with the keyboardâ€¦";
        sentenceEl.appendChild(p);
        return;
      }
      for (const w of phrase){
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.innerHTML = `<span class="mini" aria-hidden="true">ğŸ’¬</span>${escapeHtml(w)}`;
        sentenceEl.appendChild(chip);
      }
    }

    function renderTyped(){
      typedBoxEl.innerHTML = "";
      if (!typed){
        const p = document.createElement("span");
        p.className = "placeholder";
        p.textContent = "Type here with the on-screen keyboardâ€¦";
        typedBoxEl.appendChild(p);
        return;
      }
      const chip = document.createElement("span");
      chip.className = "chip";
      chip.innerHTML = `<span class="mini" aria-hidden="true">âŒ¨ï¸</span>${escapeHtml(typed)}`;
      typedBoxEl.appendChild(chip);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== Actions =====
    function addWord(word){
      if (!word) return;
      phrase.push(word);
      renderSentence();
    }

    function insertPhrase(text){
      // Insert multi-word phrase as separate chips
      const parts = text.split(/\s+/).filter(Boolean);
      for (const p of parts) phrase.push(p);
      renderSentence();
    }

    function undo(){
      // If typed has content, backspace typed first; else pop phrase
      if (typed.length > 0){
        typed = typed.slice(0, -1);
        renderTyped();
        return;
      }
      phrase.pop();
      renderSentence();
    }

    function clearAll(){
      phrase.length = 0;
      typed = "";
      window.speechSynthesis?.cancel?.();
      renderSentence();
      renderTyped();
    }

    function speak(text){
      if (!text) return;
      if (!("speechSynthesis" in window)){
        alert(text);
        return;
      }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1;
      window.speechSynthesis.speak(u);
    }

    function speakCurrent(){
      const full = [...phrase, ...(typed ? [typed] : [])].join(" ").trim();
      speak(full);
    }

    // ===== Tile clicks =====
    document.getElementById("grid").addEventListener("click", (e) => {
      const tile = e.target.closest(".tile");
      if (!tile) return;
      addWord(tile.dataset.word);
    });

    // ===== Controls =====
    btnSpeak.addEventListener("click", speakCurrent);
    btnSpeakHero.addEventListener("click", speakCurrent);
    btnUndo.addEventListener("click", undo);
    btnClear.addEventListener("click", clearAll);

    // ===== Keyboard builder =====
    const keyboardLayout = [
      ["Q","W","E","R","T","Y","U","I","O","P"],
      ["A","S","D","F","G","H","J","K","L"],
      ["Z","X","C","V","B","N","M"],
    ];

    function addKey(container, label, onClick, className){
      const k = document.createElement("div");
      k.className = "key" + (className ? " " + className : "");
      k.textContent = label;
      k.tabIndex = 0;
      k.setAttribute("role","button");
      k.addEventListener("click", onClick);
      k.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" || ev.key === " ") {
          ev.preventDefault();
          onClick();
        }
      });
      container.appendChild(k);
    }

    function buildKeyboard(){
      const kbd = document.getElementById("kbd");
      kbd.innerHTML = "";

      for (const row of keyboardLayout){
        const r = document.createElement("div");
        r.className = "kbdRow";
        for (const letter of row){
          addKey(r, letter, () => { typed += letter.toLowerCase(); renderTyped(); });
        }
        kbd.appendChild(r);
      }

      const r2 = document.createElement("div");
      r2.className = "kbdRow";
      addKey(r2, "Space", () => { typed += " "; renderTyped(); }, "xwide");
      addKey(r2, "Backspace", () => { typed = typed.slice(0,-1); renderTyped(); }, "wide");
      addKey(r2, "Enter", () => {
        const cleaned = typed.trim();
        if (cleaned) addWord(cleaned);
        typed = "";
        renderTyped();
      }, "wide");
      kbd.appendChild(r2);
    }

    // ===== Init =====
    renderSuggestions();
    buildKeyboard();
    renderSentence();
    renderTyped();
  </script>
</body>
</html>
